name: BrowserStack E2E Tests

on:
  workflow_dispatch:  # Manual trigger only (BrowserStack is paid)

jobs:
  browserstack-tests:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Install dependencies
        run: npm ci

      - name: Grant execute permission for gradlew
        run: chmod +x android/gradlew

      - name: Build Release APK
        run: |
          cd android
          ./gradlew assembleRelease --no-daemon

      - name: Upload APK to BrowserStack
        env:
          BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
          BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
        run: |
          RESPONSE=$(curl -u "$BROWSERSTACK_USERNAME:$BROWSERSTACK_ACCESS_KEY" \
            -X POST "https://api-cloud.browserstack.com/app-automate/upload" \
            -F "file=@android/app/build/outputs/apk/release/app-release.apk")
          echo "BrowserStack Response: $RESPONSE"
          APP_URL=$(echo $RESPONSE | jq -r '.app_url')
          echo "APP_URL=$APP_URL" >> $GITHUB_ENV
          echo "Uploaded APK to BrowserStack: $APP_URL"

      - name: Run E2E Tests on BrowserStack
        env:
          BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
          BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
          BROWSERSTACK_APP_URL: ${{ env.APP_URL }}
        run: |
          echo "Running tests with BrowserStack credentials"
          echo "App URL: $BROWSERSTACK_APP_URL"
          npm run test:browserstack

      - name: Get BrowserStack Session Details
        if: always()
        env:
          BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
          BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
        run: |
          echo "ðŸ“± BrowserStack Dashboard: https://app-automate.browserstack.com/dashboard/v2"
          echo "ðŸŽ¥ Videos, logs, and screenshots are available in the BrowserStack dashboard"
          echo "   - Session recordings (auto-captured for all tests)"
          echo "   - Network logs"
          echo "   - Device logs" 
          echo "   - Screenshots on failure"

      - name: Generate Allure Report
        if: always()
        run: |
          npm run allure:generate
          echo "ðŸ“Š Allure report generated"

      - name: Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: browserstack-allure-report
          path: allure-report/
          retention-days: 30

      - name: Upload Allure Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: browserstack-allure-results
          path: allure-results/
          retention-days: 30

      - name: Upload Test Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: browserstack-screenshots
          path: screenshots/
          retention-days: 7
          if-no-files-found: warn

      - name: Add Report Instructions to Summary
        if: always()
        run: |
          echo "## ðŸ“Š Test Report & Videos Available" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Allure Report" >> $GITHUB_STEP_SUMMARY
          echo "Download the \`browserstack-allure-report\` artifact and view it locally:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "cd allure-report" >> $GITHUB_STEP_SUMMARY
          echo "python3 -m http.server 8080" >> $GITHUB_STEP_SUMMARY
          echo "# Open: http://localhost:8080" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### BrowserStack Videos" >> $GITHUB_STEP_SUMMARY
          echo "View session recordings at: https://app-automate.browserstack.com/dashboard/v2" >> $GITHUB_STEP_SUMMARY
